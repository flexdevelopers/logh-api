var ViewTeamPicksController = function(leagueWeeks, currentWeek, picks, $scope, $log, $location, $stateParams, dateUtils) {

  var createFakeNonePicks = function() {
    if ($scope.picks.length < $scope.leagueWeeks.length) {
      // important that weeks are in ascending order for this to work
      for (i = $scope.picks.length; i < $scope.leagueWeeks.length; i++) {
        createFakeNonePick($scope.leagueWeeks[i]);
      }
    }
  };

  var createFakeNonePick = function(week) {
    var pick = {
      squad: {
        id: 0,
        name: "None",
        abbrev: "None",
        short: "None"
      },
      correct: (!$scope.teamData.alive) ? false : null,
      locked: (!$scope.teamData.alive) ? true : false,
      week_name: week.name,
      week_slug: week.slug,
      week_date: week.starts_at
    };
    $scope.picks.push(pick);
  };

  $scope.leagueWeeks = leagueWeeks.data;

  $scope.picks = picks.data;

  $scope.selectedWeekSlug = $stateParams.week;

  $scope.selectedWeek = _.find($scope.leagueWeeks, function(leagueWeek) { return leagueWeek.slug === $scope.selectedWeekSlug });

  $scope.correctPickCount = function(picks) {
    var correctPicks = _.filter(picks, function(pick) {
      return pick.correct;
    });
    return correctPicks.length;
  };

  $scope.changeWeek = function(slug) {
    if (slug) {
      $location.search('week', slug); // add / replace the week query param
      $scope.selectedWeek = _.find($scope.leagueWeeks, function(leagueWeek) { return leagueWeek.slug === slug });
    } else {
      $location.search('week', null); // remove week query param
      $scope.selectedWeek = null;
    }
  };

  $scope.makePick = function(team, pick) {
    if (!$scope.isCoach(team) || (pick && pick.locked)) {
      return;
    }
    if (team.league.max_picks_per_week == 1) {
      $location.url($location.path() + '/pick');
    } else {
      $location.url($location.path() + '/picks');
    }
  };

  $scope.pickStatus = function(pick) {
    var status = '';
    if (pick.correct === true) {
      status = 'check';
    } else if (pick.game && (pick.game.tie === true || pick.game.incomplete === true)) {
      status = 'minus';
    } else if (pick.correct === false) {
      status = 'times';
    } else if (pick.locked) {
      status = 'lock';
    } else {
      status = 'unlock';
    }
    return status;
  };

  $scope.pickMeta = function(pick) {
    var meta = pick.week.name;
    if (pick.game) {
      if (pick.game.note && pick.game.note.length > 0) {
        meta += ' | ' + pick.game.note;
      } else if (pick.game.tbd) {
        meta += ' | TBD';
      } else {
        meta += ' | ' + dateUtils.dateFormat(pick.game.start, "mmm d") + ' | ' + dateUtils.dateFormat(pick.game.start, "h:MM TT Z");
      }
      if (pick.game.postponed) {
        meta += ' | *PPD';
      }
      if (pick.game.if_necessary) {
        meta += ' | *If necessary';
      }
    }
    return meta;
  };

  /**
   * Invoked on startup, like a constructor.
   */
  var init = function () {
    if ($scope.teamData.league.elimination) {
      createFakeNonePicks();
    }
    if (currentWeek) {
      $scope.selectedWeekSlug = currentWeek.data.slug;
      $scope.changeWeek($scope.selectedWeekSlug);
    }
  };
  init();
};

ViewTeamPicksController.$inject = ['leagueWeeks', 'currentWeek', 'picks', '$scope', '$log', '$location', '$stateParams', 'dateUtils'];
module.exports = ViewTeamPicksController;
